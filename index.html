<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>Ø®Ø§Øµ Ù„Ù…ÙƒØªØ¨ Ø´ÙŠØ® Ù‡Ø§Ø¯ÙŠ Ø¹Ù„ÙŠ</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 1. Base Variables (Fixed to Light Mode) */
    :root{
      --brand:#0ea5e9; 
      --ink:#0f172a; 
      --muted:#64748b; 
      --surface:#ffffff; 
      --bg:#f1f5f9;
      /* Drawer background Dark: Black/Very Dark Blue as requested in image */
      --drawer-bg:#0b1220; 
      --drawer-text:#e5e7eb; 
      /* Updated Hover/Active for better contrast */
      --drawer-hover:rgba(255,255,255,.1); 
      /* Active: Blue background removed, now uses white text on dark background as in image */
      --drawer-active-dot:#facc15; /* Yellow dot for active item */
      --card-shadow:0 12px 30px rgba(2,6,23,.08);
      
      /* New: Custom Logout Color */
      --logout-color: #FF0066;
      /* New: Custom Dev Logout Color (optional different shade) */
      --logout-dev-color: #ef4444; 
    }
    
    /* 2. Global Styling & Smooth Scroll */
    html{scroll-behavior: smooth; font-size: 15px;} /* Font size adjusted for better text size */
    html,body{height:100%}
    body{background:var(--bg);color:var(--ink); transition: background .3s, color .3s}
    
    /* 3. Reusable Classes */
    .card{background:var(--surface);border-radius:1.25rem;box-shadow:var(--card-shadow);padding:1.25rem; transition: background .3s, box-shadow .3s}
    /* Updated btn style: ENSURE proper color contrast and clear background */
    .btn{
        display:inline-flex;
        align-items:center;
        gap:.5rem;
        border-radius:1rem;
        padding:.6rem 1rem; /* Smaller padding */
        font-weight:700; /* Slightly lighter bold */
        white-space: nowrap; 
        width: fit-content;
        font-size: 0.95rem; /* Slightly larger text */
        transition: background .15s, color .15s, border-color .15s;
    } 
    .btn-primary{background:var(--brand);color:#fff}
    .btn-success{background:#10b981;color:#fff}
    /* btn-plain: Adjusted to have clear border and text for better visibility */
    .btn-plain{background:var(--surface);color:var(--ink); border:1px solid var(--muted); padding: .6rem 1rem;}
    /* btn-danger: Used for confirmation button in modal (fixed to ensure visibility) */
    .btn-danger{background:#ef4444;color:#fff} 
    
    /* Custom Logout Button (Red from image) */
    .btn-logout-custom{background:var(--logout-color); color:#fff; font-size: 1.1rem; padding: .8rem 1.2rem; border: none;}
    .btn-logout-dev{background:var(--logout-dev-color); color:#fff; font-size: 1.1rem; padding: .8rem 1.2rem; border: none;}
    
    /* 4. Drawer & Navigation (Updated Colors) */
    .drawer{position:fixed;top:0;bottom:0;right:0;width:305px;background:var(--drawer-bg);color:var(--drawer-text);transform:translateX(110%);transition:transform .3s ease;padding:18px 16px 90px 16px;z-index:60; max-width: 85vw;}
    .drawer.open{transform:translateX(0)}
    
    /* Link Style */
    .drawer a{
        display:flex;
        align-items:center;
        gap:.6rem;
        border-radius:.8rem;
        /* Default item color is light gray/white on dark background */
        color:var(--drawer-text); 
        padding:.65rem .8rem; 
        transition: background .15s, color .15s;
        font-weight: 600;
    }
    .drawer a:hover{background:var(--drawer-hover)}
    
    /* Active Link Style (Requested: No specific background, just white text + yellow dot) */
    .drawer a.active{
        background:none; 
        color:#fff;
        font-weight: 700;
    }
    
    /* Active Pill (The word 'Ø§Ù„Ø­Ø§Ù„ÙŠ') */
    .drawer a.active .active-pill{
        background:#fff;
        color:var(--ink);
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 6px;
    }
    .drawer .footer-fixed{position:absolute;bottom:14px;left:16px;right:16px}
    
    /* 5. Misc */
    .bubble{border:1px dashed var(--muted);border-radius:1rem;padding:1rem}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .fade-enter{animation:fade .25s ease}
    @keyframes fade{from{opacity:.0;transform:translateY(4px)}to{opacity:1;transform:none}}
    .toast{position:fixed;bottom:18px;right:18px;z-index:80}
    .float-anim{animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
    
    /* 6. Modal Styling */
    .modal-overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px);}
    /* Increased modal size slightly for better button display */
    .modal-content {background: var(--surface); padding: 1.5rem; border-radius: 1rem; max-width: 90vw; width: 450px; box-shadow: var(--card-shadow);}

    /* 7. Responsive Adjustments */
    @media (max-width: 767px) {
        .card { padding: 1rem; }
        .drawer { width: 85vw; }
        /* Smaller font size for mobile utility elements */
        .btn { font-size: 0.9rem; padding: .6rem .8rem; } 
        .drawer a { font-size: 0.95rem; }
        .modal-content {width: 90vw;}
    }
    
    /* 8. Project Host height adjustment for mobile */
    #projectHost { min-height: 50vh; height: auto; }
    @media (min-width: 768px) {
        #projectHost { height: 60vh; }
    }
  </style>
</head>
<body class="min-h-screen">
  
  <div id="logoutModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="font-black text-lg mb-4">ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
      <p class="text-sm mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</p>
      <div class="flex justify-end gap-3">
        <button id="cancelLogoutBtn" class="btn btn-plain">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="confirmLogoutBtn" class="btn btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200 transition duration-300">
    <div class="mx-auto max-w-6xl px-3 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="openDrawerBtn" class="btn btn-plain p-2" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" style="width: auto;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1 id="appBarTitle" class="font-black tracking-tight text-xl sm:text-lg">Ø®Ø§Øµ Ù„Ù…ÙƒØªØ¨ Ø´ÙŠØ® Ù‡Ø§Ø¯ÙŠ Ø¹Ù„ÙŠ</h1>
      </div>
      <div class="flex items-center gap-2">
        <div id="onlinePill" class="chip"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Ù…ØªØµÙ„</div>
      </div>
    </div>
  </header>

  <aside id="drawer" class="drawer">
    <div class="flex items-center justify-between mb-2">
      <div class="font-extrabold text-lg text-white">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
      <button id="closeDrawerBtn" class="p-2 rounded-full text-white hover:bg-slate-700 transition" title="Ø¥ØºÙ„Ø§Ù‚" style="width: auto;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    
    <nav id="projectsList" class="space-y-1 overflow-y-auto" style="max-height: 55vh;"></nav>

    <div class="footer-fixed flex flex-col gap-2 items-center">
      <button id="aboutDevBtn" class="btn w-full justify-center bg-white text-slate-800 hover:bg-slate-200" style="border: none; font-size: 1rem; border-radius: 1.5rem;">Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</button>
      
      <button id="userLogoutBtn" class="btn btn-logout-custom w-full mt-1 justify-center rounded-[1.5rem]" style="width: 100%;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ (Ù…Ø³ØªØ®Ø¯Ù…)</span>
      </button>

      <button id="devLogoutBtn" class="btn btn-logout-dev w-full mt-1 justify-center rounded-[1.5rem] hidden" style="width: 100%;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ (Ù…Ø·ÙˆÙ‘Ø±)</span>
      </button>
      
      <div class="mt-3 flex gap-4 items-center justify-center">
        
        <a id="socWa" target="_blank" rel="noopener" title="ÙˆØ§ØªØ³Ø§Ø¨" href="#"
           class="bg-green-500 hover:bg-green-600 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-lg transition-all duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12.04 2C6.57 2 2 6.57 2 12.04c0 1.99.52 3.94 1.52 5.66L2 22l4.43-1.48A10.02 10.02 0 0 0 12.04 22C17.5 22 22 17.43 22 11.96 22 6.57 17.5 2 12.04 2zm0 18.36c-1.79 0-3.54-.5-5.06-1.45l-.36-.22-2.63.88.88-2.56-.23-.38A8.15 8.15 0 0 1 3.64 12a8.42 8.42 0 0 1 8.4-8.36c4.63 0 8.4 3.76 8.4 8.36s-3.77 8.36-8.4 8.36zm4.71-6.28c-.26-.13-1.54-.76-1.77-.85-.24-.09-.41-.13-.59.13-.18.27-.67.85-.82 1.03-.15.18-.3.2-.56.07a6.79 6.79 0 0 1-2-1.23 7.54 7.54 0 0 1-1.4-1.74c-.15-.26-.02-.4.11-.53.12-.12.27-.32.41-.48.13-.16.18-.27.27-.45.09-.18.05-.33-.02-.46-.07-.13-.59-1.42-.81-1.94-.21-.5-.42-.43-.59-.43h-.5c-.17 0-.45.06-.69.33-.24.27-.9.88-.9 2.15 0 1.27.92 2.5 1.05 2.67.13.18 1.8 2.87 4.36 4.02.61.26 1.08.42 1.45.54.61.19 1.17.16 1.61.1.49-.07 1.54-.63 1.76-1.24.22-.61.22-1.14.15-1.25-.06-.11-.24-.18-.5-.31z"/>
          </svg>
        </a>
        
        <a id="socTg" target="_blank" rel="noopener" title="ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…" href="#" 
           class="bg-sky-500 hover:bg-sky-600 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-lg transition-all duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6" viewBox="0 0 24 24">
            <path d="M9.036 15.47 8.85 19.77c.4 0 .58-.18.79-.4l1.9-1.81 3.94 2.89c.72.4 1.24.19 1.43-.67l2.6-12.18.002-.001c.23-1.08-.39-1.51-1.09-1.24l-15.3 5.9c-1.05.42-1.03 1.03-.18 1.31l3.93 1.23L16.4 8.02c.38-.23.72-.1.44.13"/>
          </svg>
        </a>

        <a id="socIg" target="_blank" rel="noopener" title="Ø¥Ù†Ø³ØªØºØ±Ø§Ù…" href="#" 
           class="bg-gradient-to-tr from-pink-500 to-yellow-400 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-lg transition-all duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6" viewBox="0 0 24 24">
            <path d="M7.75 2h8.5A5.76 5.76 0 0 1 22 7.75v8.5A5.76 5.76 0 0 1 16.25 22h-8.5A5.76 5.76 0 0 1 2 16.25v-8.5A5.76 5.76 0 0 1 7.75 2Zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5A4.25 4.25 0 0 0 20.5 16.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5Zm4.25 3.25a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11Zm0 1.5a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm5.75-.88a1.12 1.12 0 1 1 0 2.25 1.12 1.12 0 0 1 0-2.25Z"/>
          </svg>
        </a>
      </div>
    </div>
  </aside>

  <main class="mx-auto max-w-6xl px-3 py-6 space-y-6">
    <section id="maintenanceBanner" class="hidden card fade-enter border border-amber-200 bg-amber-50">
      <div class="flex items-start gap-3">
        <div class="pt-1"><span class="inline-block w-3 h-3 rounded-full bg-amber-500"></span></div>
        <div>
          <h2 class="font-extrabold text-amber-800 mb-1">Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
          <p class="text-amber-800/90 mb-3">Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ù‚ÙˆÙ… Ø¨Ø£Ø¹Ù…Ø§Ù„ ØµÙŠØ§Ù†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹. Ù„Ù„ØªÙˆØ§ØµÙ„:</p>
          <div class="flex gap-2 flex-wrap">
            <a id="mWa" class="btn btn-primary" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
            <a id="mTg" class="btn btn-plain" target="_blank" rel="noopener">ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</a>
            <a id="mIg" class="btn btn-plain" target="_blank" rel="noopener">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</a>
          </div>
        </div>
      </div>
    </section>

    <section id="authView" class="card fade-enter">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-black text-xl">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      </div>
      
      <div class="bubble mb-6">
        <h3 class="font-extrabold mb-2">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</h3>
        <p class="text-sm text-slate-600 mb-3">Ù‚Ù… Ø¨Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
        <form id="userLoginForm" class="space-y-2">
          <input required id="userCodeInput" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯" />
          <div class="flex justify-center">
            <button class="btn btn-primary" type="submit">Ø¯Ø®ÙˆÙ„</button>
          </div>
          <div class="text-xs text-slate-500 text-center">Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„ Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</div>
        </form>
      </div>
      
      <div class="mt-8 text-center">
          <h3 class="font-extrabold mb-3">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h3>
          <div class="flex flex-wrap justify-center gap-2">
            <a id="authWa" class="btn border-green-500 text-green-700 hover:bg-green-50" target="_blank" rel="noopener" href="#">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M.057 24l1.687-6.163A10.9 10.9 0 0 1 0 10.989C0 4.93 4.93 0 10.988 0a10.95 10.95 0 0 1 7.78 3.223 10.95 10.95 0 0 1 3.222 7.78c0 6.059-4.93 10.988-10.988 10.988a10.9 10.9 0 0 1-5.21-1.354L.057 24zM6.6 19.36c1.676.995 3.276 1.591 4.388 1.591h.004c4.987 0 9.06-4.073 9.06-9.06.002-2.423-.942-4.701-2.652-6.412A9.02 9.02 0 0 0 10.99 1.5C6.003 1.5 1.93 5.573 1.93 10.56c0 1.75.46 3.457 1.334 4.956l-.88 3.226 3.216-.86z"/></svg>
                ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
            </a>
            <a id="authTg" class="btn border-blue-400 text-blue-600 hover:bg-blue-50" target="_blank" rel="noopener" href="#">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm4.2 8.4l-1.8 8.8c-.1.4-.4.5-.8.3l-2.4-1.7-1.1 1.1c-.2.2-.4.4-.8.4h-.1c-.3 0-.5-.2-.5-.5v-2.2l-3.3-2.6c-.4-.4-.3-.7.1-.6l10-4c.4-.2.7-.1.6.3z"/></svg>
                ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
            </a>
            <a id="authIg" class="btn border-pink-500 text-pink-700 hover:bg-pink-50" target="_blank" rel="noopener" href="#">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #E1306C;">
                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                    <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                </svg>
                ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø¥Ù†Ø³ØªØºØ±Ø§Ù…
            </a>
          </div>
          <div class="mt-4 text-xs text-slate-500 float-anim">
            &copy; Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ© Ù…Ø­ÙØ¸Ø© : By_@Memu199.
          </div>
      </div>
    </section>

    <section id="userView" class="hidden fade-enter">
      <div class="card mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="chip">Ù…Ø³ØªØ®Ø¯Ù…:</span>
            <span id="currentUserName" class="font-extrabold"></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-slate-600">
            <span>Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯:</span>
            <span id="codeStatusPill" class="chip">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-extrabold mb-2">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶</h3>
        <div id="projectHost" class="rounded-xl border border-slate-200 overflow-auto p-3 bg-white"></div>
      </div>
    </section>

    <section id="devView" class="hidden fade-enter">
      <div class="card mb-4">
        <div class="flex flex-wrap items-center justify-start gap-3">
          <div class="flex flex-wrap items-center gap-2">
            <button id="toProjectsTab" class="btn btn-plain text-sm p-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
            <button id="toCodesTab" class="btn btn-plain text-sm p-2">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
            <button id="toSettingsTab" class="btn btn-plain text-sm p-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button id="toAboutDevTab" class="btn btn-plain text-sm p-2">Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</button>
          </div>
        </div>
      </div>

      <div id="devTabs" class="space-y-6">
        <div id="projectsTab" class="card">
          <h3 class="font-extrabold mb-3">Ø¥Ø¶Ø§ÙØ© / ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3>
          <form id="addProjectForm" class="space-y-3">
            <input required id="projName" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù…Ø«Ø§Ù„: Ù…Ø§Ø¯Ø© 140)" />
            <textarea required id="projHTML" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 mono" rows="10" placeholder="Ø£Ù„ØµÙ‚ ÙƒÙˆØ¯ HTML Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‡Ù†Ø§"></textarea>
            <div class="flex flex-wrap gap-2">
              <button id="addProjectSubmitBtn" class="btn btn-primary" type="submit">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</button>
              <button id="clearProjectForm" class="btn btn-plain" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
            </div>
            <div class="text-xs text-slate-500">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Firestore ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡ Ù…Ø­Ù„ÙŠØ§Ù‹.</div>
          </form>

          <hr class="my-4 border-slate-200"/>
          <h4 class="font-extrabold mb-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
          <div id="projectsManager" class="space-y-2"></div>
        </div>

        <div id="codesTab" class="card hidden">
          <h3 class="font-extrabold mb-3">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡Ø§</h3>
          <form id="genCodeForm" class="grid md:grid-cols-4 gap-2 items-end">
            <div class="md:col-span-1">
              <label class="text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
              <input id="gcUsername" required class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ù…Ø­Ø³Ù†" />
            </div>
            <div>
              <label class="text-sm">Ø§Ù„Ù…Ø¯Ù‘Ø©</label>
              <input id="gcAmount" type="number" min="1" value="1" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
              <select id="gcUnit" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                <option value="minutes">Ø¯Ù‚Ø§Ø¦Ù‚</option>
                <option value="hours">Ø³Ø§Ø¹Ø§Øª</option>
                <option value="days" selected>Ø£ÙŠØ§Ù…</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
              </select>
            </div>
            <div>
              <button class="btn btn-primary w-full" type="submit">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
            </div>
          </form>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm min-w-[700px]">
              <thead>
                <tr class="text-left border-b border-slate-200">
                  <th class="py-2 px-1">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th class="py-2 px-1">Ø§Ù„ÙƒÙˆØ¯</th>
                  <th class="py-2 px-1">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                  <th class="py-2 px-1">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th class="py-2 px-1">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¢Ù†</th>
                  <th class="py-2 px-1">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="codesTable"></tbody>
            </table>
          </div>
        </div>

        <div id="settingsTab" class="card hidden">
          <h3 class="font-extrabold mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</h3>
          <form id="settingsForm" class="grid md:grid-cols-3 gap-3">
            <div class="md:col-span-1">
              <label class="text-sm font-bold">ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
              <div class="mt-2 flex items-center gap-2">
                <input id="maintenanceToggle" type="checkbox" class="scale-125"/>
                <span class="text-sm text-slate-600">ÙŠÙ…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯.</span>
              </div>
            </div>
            <div>
              <label class="text-sm font-bold">Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</label>
              <input id="setWa" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="https://wa.me/"/>
            </div>
            <div>
              <label class="text-sm font-bold">Ø±Ø§Ø¨Ø· ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</label>
              <input id="setTg" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="https://t.me/"/>
            </div>
            <div>
              <label class="text-sm font-bold">Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</label>
              <input id="setIg" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="https://instagram.com/"/>
            </div>
            <div class="md:col-span-3">
              <label class="text-sm font-bold">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</label>
              <input id="setDevKey" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" placeholder="Ø¶Ø¹ ÙƒÙˆØ¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±"/>
            </div>
            <div class="md:col-span-3">
              <button class="btn btn-primary" type="submit">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
          </form>
        </div>
        
        <div id="aboutDevTab" class="card hidden">
          <h3 class="font-extrabold mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙØ­Ø© "Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±"</h3>
          <form id="aboutDevForm" class="space-y-3">
            <textarea id="aboutDevHTML" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 mono" rows="10" placeholder="Ø£Ù„ØµÙ‚ ÙƒÙˆØ¯ HTML Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§ Ù„ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±"></textarea>
            <button class="btn btn-primary" type="submit">Ø­ÙØ¸ Ù…Ø­ØªÙˆÙ‰ Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</button>
          </form>
        </div>
        
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>
  
  <div id="projectFooter" class="fixed bottom-0 right-0 left-0 text-center p-2 bg-slate-800 text-white text-xs opacity-90 transition duration-500 float-anim hidden">
    &copy; Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ© Ù…Ø­ÙØ¸Ø© : By_@Memu199.
  </div>

  <script type="module">
    /*********************************
     * Ù¡) Firebase
     *********************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection,
      addDoc, deleteDoc, query, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBXN4njw1kCHPV28kEYmAk_8a0iazlkbfY",
      authDomain: "memu99m.firebaseapp.com",
      projectId: "memu99m",
      storageBucket: "memu99m.firebasestorage.app",
      messagingSenderId: "460246646958",
      appId: "1:460246646958:web:6133e858bce2444a3c6d3f",
      measurementId: "G-65FLDMSM1P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    /*********************************
     * Ù¢) DOM helpers
     *********************************/
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const body = $('body');
    const html = $('html');
    const drawer = $('#drawer');
    const openDrawerBtn = $('#openDrawerBtn');
    const closeDrawerBtn = $('#closeDrawerBtn');
    const projectsList = $('#projectsList');
    const projectHost = $('#projectHost');
    
    // ğŸ”” ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²Ø±ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ÙŠÙ† Ù‡Ù†Ø§ ğŸ””
    const userLogoutBtn = $('#userLogoutBtn'); 
    const devLogoutBtn = $('#devLogoutBtn'); 
    
    const appBarTitle = $('#appBarTitle');
    const onlinePill = $('#onlinePill');
    const toastEl = $('#toast');
    const projectFooter = $('#projectFooter');

    const maintenanceBanner = $('#maintenanceBanner');
    const authView = $('#authView');
    const userView = $('#userView');
    const devView = $('#devView');

    const userLoginForm = $('#userLoginForm');
    const userCodeInput = $('#userCodeInput');

    const currentUserName = $('#currentUserName');
    const codeStatusPill = $('#codeStatusPill');

    const toProjectsTab = $('#toProjectsTab');
    const toCodesTab = $('#toCodesTab');
    const toSettingsTab = $('#toSettingsTab');
    const toAboutDevTab = $('#toAboutDevTab');

    const projectsTab = $('#projectsTab');
    const codesTab = $('#codesTab');
    const settingsTab = $('#settingsTab');
    const aboutDevTab = $('#aboutDevTab');

    const addProjectForm = $('#addProjectForm');
    const addProjectSubmitBtn = $('#addProjectSubmitBtn');
    const projName = $('#projName');
    // ğŸ”” ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ø±ÙŠÙ Ø­Ù‚Ù„ HTML Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒÙˆØ¯ ğŸ””
    const projHTML = $('#projHTML'); 
    const clearProjectForm = $('#clearProjectForm');
    const projectsManager = $('#projectsManager');

    const genCodeForm = $('#genCodeForm');
    const genCodeSubmitBtn = genCodeForm.querySelector('[type="submit"]');
    const gcUsername = $('#gcUsername');
    const gcAmount = $('#gcAmount');
    const gcUnit = $('#gcUnit');
    const codesTable = $('#codesTable');

    const settingsForm = $('#settingsForm');
    const maintenanceToggle = $('#maintenanceToggle');
    const setWa = $('#setWa');
    const setTg = $('#setTg');
    const setIg = $('#setIg');
    const setDevKey = $('#setDevKey');
    
    const aboutDevForm = $('#aboutDevForm');
    const aboutDevHTML = $('#aboutDevHTML');

    const socWa = $('#socWa');
    const socTg = $('#socTg');
    const socIg = $('#socIg');
    const mWa = $('#mWa');
    const mTg = $('#mTg');
    const mIg = $('#mIg');
    
    const authWa = $('#authWa');
    const authTg = $('#authTg');
    const authIg = $('#authIg');
    const aboutDevBtn = $('#aboutDevBtn'); // ØªØ¹Ø±ÙŠÙ Ø²Ø± "Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±"
    
    // Logout Modal Elements
    const logoutModal = $('#logoutModal');
    const confirmLogoutBtn = $('#confirmLogoutBtn');
    const cancelLogoutBtn = $('#cancelLogoutBtn');


    /*********************************
     * 3) Helpers
     *********************************/
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const deviceId = (function(){
      let id = localStorage.getItem('deviceId');
      if(!id){ id = crypto.randomUUID(); localStorage.setItem('deviceId', id); }
      return id;
    })();
    
    function showToast(msg){
      toastEl.classList.remove('hidden');
      toastEl.innerHTML = `<div class="card">${msg}</div>`;
      setTimeout(()=>toastEl.classList.add('hidden'), 2400);
    }

    function setOnlineUI(){
      const online = navigator.onLine;
      onlinePill.innerHTML = online
        ? '<span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Ù…ØªØµÙ„'
        : '<span class="inline-block w-2 h-2 rounded-full bg-slate-400"></span> ØºÙŠØ± Ù…ØªØµÙ„';
    }
    window.addEventListener('online',()=>{ setOnlineUI(); revalidateIfNeeded(); });
    window.addEventListener('offline',()=>{ setOnlineUI(); });

    function nowTs(){ return Date.now(); }
    function addDuration(ms, amount, unit){
      const map = {minutes:60000, hours:3600000, days:86400000, months:2629800000};
      return ms + (map[unit]||86400000) * amount;
    }
    function fmtDate(ts){
      try{ return new Date(ts).toLocaleString('ar-IQ'); }catch{return ts}
    }
    function randCode(len=8){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out=''; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function statusPillHtml(valid){
      return valid ? '<span class="chip"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> ØµØ§Ù„Ø­</span>'
                   : '<span class="chip"><span class="inline-block w-2 h-2 rounded-full bg-rose-500"></span> ØºÙŠØ± ØµØ§Ù„Ø­</span>';
    }
    function usedNowPillHtml(used){
      return used ? '<span class="chip"><span class="inline-block w-2 h-2 rounded-full bg-amber-500"></span> ÙŠÙØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù†</span>'
                  : '<span class="chip">ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…</span>';
    }
    function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
    // ØªÙ†Ù‚ÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ© ØªÙ…Ù†Ø¹ XSS: ØªØ²ÙŠÙ„ <script> ÙˆØ³Ù…Ø§Øª on* ÙˆØ±ÙˆØ§Ø¨Ø· javascript:
function sanitizeHtml(unsafeHtml){
  const tpl = document.createElement('template');
  tpl.innerHTML = unsafeHtml ?? '';
  // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª
  tpl.content.querySelectorAll('script').forEach(n=>n.remove());
  // Ø¥Ø²Ø§Ù„Ø© on* ÙˆØ§Ù„Ù€ javascript: Ù…Ù† href/src
  const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_ELEMENT);
  while(walker.nextNode()){
    const el = walker.currentNode;
    for(const attr of Array.from(el.attributes)){
      if(/^on/i.test(attr.name)) el.removeAttribute(attr.name);
      if(/^(href|src)$/i.test(attr.name) && /^javascript:/i.test(attr.value)) el.removeAttribute(attr.name);
    }
  }
  return tpl.innerHTML;
}

    /*********************************
     * Ù¤) Ø¬Ù„Ø³Ø© + ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ - Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§
     *********************************/
    let editingProjectId = null;
    let editingCodeId = null;
    let activeProjectId = null;
    
    const session = {
      get(){ 
        try{
          const ses = localStorage.getItem('session');
          console.log('Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† localStorage:', ses);
          return ses ? JSON.parse(ses) : null;
        }catch(e){
          console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ù„Ø³Ø©:', e);
          return null;
        }
      },
      set(obj){
        try{
          console.log('Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ localStorage:', obj);
          localStorage.setItem('session', JSON.stringify(obj)); 
        }catch(e){
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©:', e);
        }
      },
      clear(){ 
        console.log('Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø©');
        localStorage.removeItem('session'); 
      }
    };
    
    function setView(view){
      const ses = session.get();
      console.log('setView called - Ø§Ù„Ø¬Ù„Ø³Ø©:', ses, 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:', view.id);
      
      for(const el of [authView,userView,devView]) el.classList.add('hidden');
      view.classList.remove('hidden');
      
      const showDrawer = (view !== authView);
      openDrawerBtn.classList.toggle('hidden', !showDrawer); 
      projectFooter.classList.toggle('hidden', view !== userView);
      
      // Update AppBar Title
      appBarTitle.textContent = (view === devView) ? 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±' : 'Ø®Ø§Øµ Ù„Ù…ÙƒØªØ¨ Ø´ÙŠØ® Ù‡Ø§Ø¯ÙŠ Ø¹Ù„ÙŠ';
      
      // ğŸ”” Ù…Ù†Ø·Ù‚ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸ””
      const isDev = (ses?.role === 'dev');
      
      // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±
      userLogoutBtn.classList.toggle('hidden', isDev);
      // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      devLogoutBtn.classList.toggle('hidden', !isDev);
      
      // Fix: Hide drawer when logging out or switching to authView
      if (view === authView) {
        drawer.classList.remove('open');
      }
      
      console.log('setView completed - Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ:', view.id);
    }

    /*********************************
     * Ù¥) Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
     *********************************/
    let settingsDocUnsub = null;
    async function watchSettings(){
      if(settingsDocUnsub) settingsDocUnsub();
      const sRef = doc(db, 'settings', 'main');
      settingsDocUnsub = onSnapshot(sRef, (snap)=>{
        const s = snap.exists()? snap.data(): {};
        const { maintenance=false, wa='#', tg='#', ig='#', devKey='', aboutDevHtml='' } = s;
        
        maintenanceToggle.checked = !!maintenance;
        setWa.value = wa || '';
        setTg.value = tg || '';
        setIg.value = ig || '';
        setDevKey.value = devKey || '';
        aboutDevHTML.value = aboutDevHtml || '';

        // Update all social links (Drawer, Maintenance, Auth View)
        [socWa, mWa, authWa].forEach(a=>a.href = wa||'#');
        [socTg, mTg, authTg].forEach(a=>a.href = tg||'#');
        [socIg, mIg, authIg].forEach(a=>a.href = ig||'#');

        const ses = session.get();
        maintenanceBanner.classList.toggle('hidden', !maintenance);
        if(maintenance){
          if(ses && ses.role==='user' && navigator.onLine){
            showToast('Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ØµÙŠØ§Ù†Ø© â€” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ');
            doLogout(true, false, true); // Force logout without confirmation
          }
        }
      });
    }
    settingsForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const sRef = doc(db, 'settings', 'main');
      await setDoc(sRef, {
        maintenance: maintenanceToggle.checked,
        wa: setWa.value.trim(),
        tg: setTg.value.trim(),
        ig: setIg.value.trim(),
        devKey: setDevKey.value.trim()
      }, { merge:true });
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    });
    
    aboutDevForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const html = aboutDevHTML.value;
        const sRef = doc(db, 'settings', 'main');
        await setDoc(sRef, { aboutDevHtml: html }, { merge:true });
        showToast('ØªÙ… Ø­ÙØ¸ Ù…Ø­ØªÙˆÙ‰ "Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±"');
    });

    /*********************************
     * Ù¦) ØªØ­Ù‚Ù‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ + Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯
     *********************************/
    async function verifyCodeOnline(code){
      const ref = doc(db,'one_time_codes', code);
      const snap = await getDoc(ref);
      if(!snap.exists()) return { ok:false, reason:'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
      const data = snap.data();
      const { username='Ù…Ø³ØªØ®Ø¯Ù…', expiresAt=0, revoked=false, suspended=false, used=false, boundTo='' } = data;
      const exp = (typeof expiresAt==='number'? expiresAt : expiresAt?.toMillis?.() ?? 0);
      const validTime = nowTs() < exp;
      if(revoked) return { ok:false, reason:'Ø§Ù„ÙƒÙˆØ¯ Ù…Ù„ØºÙŠ', data };
      if(suspended) return { ok:false, reason:'Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªØ§Ù‹', data };
      if(!validTime) return { ok:false, reason:'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯', data };

      if(boundTo && boundTo !== deviceId){
        return { ok:false, reason:'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±', data };
      }
      
      if(!used || !boundTo){
          await setDoc(ref, { used:true, boundTo: deviceId, lastSeen: nowTs() }, {merge:true});
      }
      
      // Update DB state if session is no longer valid
      if(!validTime || revoked || suspended){
          session.clear(); 
          if(data.used && data.boundTo === deviceId){
             await setDoc(ref, { used: false, boundTo: '' }, {merge:true});
          }
      }

      await setDoc(ref, { used:true, boundTo: deviceId, lastSeen: nowTs() }, {merge:true});
      return { ok:true, data:{...data, username, expiresAt:exp, used:true, boundTo:deviceId} };
    }
    
    async function revalidateIfNeeded(){
      const ses = session.get();
      if(!ses || ses.role!=='user') return;
      if(!navigator.onLine) return;
      const res = await verifyCodeOnline(ses.code);
      if(!res.ok){
        codeStatusPill.innerHTML = statusPillHtml(false);
        showToast(res.reason||'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©');
        await sleep(600);
        doLogout(false, false, true); // Force logout without confirmation
      }else{
        codeStatusPill.innerHTML = statusPillHtml(true);
      }
    }

    /*********************************
     * Ù§) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
     *********************************/
    userLoginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const inputCode = userCodeInput.value.trim();
      if(!inputCode) return;

      // Ù…Ø·ÙˆÙ‘Ø±ØŸ
      const settingsSnap = await getDoc(doc(db, 'settings', 'main'));
      const devKey = settingsSnap.data()?.devKey || '';

      if(inputCode && inputCode.trim() === devKey.trim()){
        session.set({ role:'dev' });
        setView(devView);
        watchProjects();
        listenCodes();
        showTab('projects');
        showToast('Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ğŸ‘¨â€ğŸ’»');
        return;
      }

      // Ù…Ø³ØªØ®Ø¯Ù…ØŸ
      if(maintenanceToggle.checked){
        showToast('Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹');
        return;
      }
      if(!navigator.onLine){
        showToast('ÙŠØªØ·Ù„Ø¨ Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©');
        return;
      }
      const code = inputCode.toUpperCase();
      const res = await verifyCodeOnline(code);
      if(!res.ok){
        showToast(res.reason || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯');
        return;
      }
      const username = res.data.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
      currentUserName.textContent = username;
      codeStatusPill.innerHTML = statusPillHtml(true);
      session.set({ role:'user', code, username, expiresAt:res.data.expiresAt || 0 });
      setView(userView);
      watchProjects();
      await revalidateIfNeeded();
      showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ '+username+' âœ¨');
    });

    /*********************************
     * Ù¨) Ø§Ù„Ø®Ø±ÙˆØ¬
     *********************************/
    let isDevLogout = false;

    async function doLogout(clearDbState=true, showConfirmation=true, forced=false){
      const ses = session.get();
      isDevLogout = ses?.role === 'dev';

      if(showConfirmation && !forced){
        logoutModal.classList.remove('hidden');
        // ğŸ”” ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ± ğŸ””
        confirmLogoutBtn.textContent = isDevLogout ? 'Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±' : 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬';
        return;
      }
      
      if(ses && ses.role==='user' && clearDbState){
          const ref = doc(db,'one_time_codes', ses.code);
          await updateDoc(ref, { used: false, boundTo: '' }).catch(console.error);
      }
      
      activeProjectId = null;
      renderProjectsUI();
      
      session.clear();
      // FIX: Crucial Fix: ensure drawer is hidden before setting view to authView
      drawer.classList.remove('open');
      setView(authView); 
      
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
    }

    // ğŸ”” ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„ÙŠØªÙ…ÙƒÙ† Ø²Ø± Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸ””
    userLogoutBtn.addEventListener('click', ()=>{ doLogout(true, true); });
    devLogoutBtn.addEventListener('click', ()=>{ doLogout(false, true); }); // Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± Ù„Ø§ ÙŠÙ…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯

    cancelLogoutBtn.addEventListener('click', ()=>{
        logoutModal.classList.add('hidden');
    });

    confirmLogoutBtn.addEventListener('click', async ()=>{
        logoutModal.classList.add('hidden');
        // isDevLogout ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙÙŠ doLogout(..., true, ...)
        await doLogout(!isDevLogout, false); 
    });


    /*********************************
     * Ù©) Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Ø¥Ø¶Ø§ÙØ©/ØªØ±ØªÙŠØ¨/Ø¹Ø±Ø¶)
     *********************************/
    let projectsUnsub = null;
    let cachedProjects = [];

    function renderProjectsUI(){
      projectsList.innerHTML = cachedProjects.map((p)=>{
        const isActive = p.id === activeProjectId;
        const activeClass = isActive ? 'active' : '';
        // Requested: Yellow dot, white text, green 'Ø§Ù„Ø­Ø§Ù„ÙŠ' pill
        const dotColor = isActive ? 'var(--drawer-active-dot)' : 'var(--drawer-text)';
        const statusPill = isActive ? '<span class="active-pill">Ø§Ù„Ø­Ø§Ù„ÙŠ</span>' : ''; 
        return `
          <a href="#" data-projid="${p.id}" class="${activeClass} flex items-center justify-between text-base font-bold">
            <div class="flex items-center gap-3">
              <span class="inline-block w-2 h-2 rounded-full" style="background-color: ${dotColor};"></span>
              <span class="text-white">${escapeHtml(p.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</span>
            </div>
            ${statusPill}
          </a>
        `;
      }).join('');
      
      // FIX: Render for aboutDevBtn - update button style if it's the active view
      if (activeProjectId === 'aboutDev') {
          aboutDevBtn.classList.remove('bg-white', 'text-slate-800');
          aboutDevBtn.classList.add('bg-slate-700', 'text-white');
      } else {
          aboutDevBtn.classList.remove('bg-slate-700', 'text-white');
          aboutDevBtn.classList.add('bg-white', 'text-slate-800');
      }

      projectsManager.innerHTML = cachedProjects.map((p,i)=>`
        <div class="border border-slate-200 rounded-xl p-3 bg-white">
          <div class="flex flex-wrap items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="font-extrabold text-slate-900 text-sm">${escapeHtml(p.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</div>
              <div class="text-[11px] text-slate-500 break-all mono">ID: ${p.id}</div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button class="btn btn-plain text-xs p-2" data-act="up" data-pid="${p.id}">ÙÙˆÙ‚â†‘</button>
              <button class="btn btn-plain text-xs p-2" data-act="down" data-pid="${p.id}">ØªØ­Øªâ†“</button>
              <button class="btn btn-primary text-xs p-2" data-act="edit" data-pid="${p.id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn text-xs p-2" style="background-color: #ef4444; color: white;" data-act="del" data-pid="${p.id}">Ø­Ø°Ù</button>
              <button class="btn btn-plain text-xs p-2" data-act="preview" data-pid="${p.id}">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            </div>
          </div>
        </div>
      `).join('');

      openFirstProjectIfAny();
    }

    function swapOrder(i,j){
      if(i<0 || j<0 || i>=cachedProjects.length || j>=cachedProjects.length) return;
      const pi = cachedProjects[i], pj = cachedProjects[j];
      const piRef = doc(db,'projects',pi.id);
      const pjRef = doc(db,'projects',pj.id);
      const oldI = pi.order ?? i, oldJ = pj.order ?? j;
      cachedProjects[i].order = oldJ;
      cachedProjects[j].order = oldI;
      updateDoc(piRef,{order:oldJ}).catch(()=>{});
      updateDoc(pjRef,{order:oldI}).catch(()=>{});
    }
    
    projectsManager.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const pid = btn.dataset.pid;
      const idx = cachedProjects.findIndex(p=>p.id===pid);
      if(idx===-1) return;
      const p = cachedProjects[idx];

      if(act==='up'){ swapOrder(idx, idx-1); renderProjectsUI(); }
      else if(act==='down'){ swapOrder(idx, idx-1); renderProjectsUI(); }
      else if(act==='del'){
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
          await deleteDoc(doc(db,'projects',pid));
          showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        }
      }else if(act==='edit'){
          projName.value = p.name || '';
          projHTML.value = p.html || '';
          editingProjectId = pid;
          addProjectSubmitBtn.textContent = 'Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹';
          addProjectSubmitBtn.classList.remove('btn-primary');
          addProjectSubmitBtn.classList.add('btn-success');
          showTab('projects');
          showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.');
      }else if(act==='preview'){
        // FIX APPLIED: Project code renders directly into projectHost without sanitization
        projectHost.innerHTML = p.html || ''; // <--- ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§
        setView(userView);
        drawer.classList.remove('open');
        activeProjectId = pid;
        renderProjectsUI();
        showToast('ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
      }
    });

    projectsList.addEventListener('click',(e)=>{
      const link = e.target.closest('[data-projid]');
      if(!link) return;
      e.preventDefault(); // Prevent default link behavior
      const pid = link.dataset.projid;
      const p = cachedProjects.find(x=>x.id===pid);
      if(!p) return;
      
      // FIX APPLIED: Project code renders directly into projectHost without sanitization
      projectHost.innerHTML = p.html || ''; // <--- ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§
      
      drawer.classList.remove('open');
      
      activeProjectId = pid;
      renderProjectsUI();
    });

    function openFirstProjectIfAny(){
      const ses = session.get();
      if(!ses || ses.role!=='user') return;
      
      // Check if user is in userView and projectHost is empty
      if(userView && !userView.classList.contains('hidden')){
        const first = cachedProjects[0];
        if(first && !activeProjectId){ 
          projectHost.innerHTML = first.html || ''; 
          activeProjectId = first.id;
          renderProjectsUI();
        }
      }
    }

    addProjectForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = projName.value.trim();
      const html = projHTML.value;
      if(!name || !html){ showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
      
      if(editingProjectId){
          const ref = doc(db,'projects',editingProjectId);
          await updateDoc(ref, { name, html });
          showToast('ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
      }else{
          // Find the current max order value
          const maxOrder = cachedProjects.length > 0 ? cachedProjects[0].order + 1 : nowTs();
          await addDoc(collection(db,'projects'), { name, html, order: maxOrder });
          showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
      }
      
      projName.value=''; 
      projHTML.value='';
      editingProjectId = null;
      addProjectSubmitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
      addProjectSubmitBtn.classList.remove('btn-success');
      addProjectSubmitBtn.classList.add('btn-primary');
    });
    
    clearProjectForm.addEventListener('click', ()=>{ 
        projName.value=''; 
        projHTML.value=''; 
        editingProjectId = null;
        addProjectSubmitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
        addProjectSubmitBtn.classList.remove('btn-success');
        addProjectSubmitBtn.classList.add('btn-primary');
    });

    function watchProjects(){
      if(projectsUnsub) return;
      // Order by descending order to ensure drag/drop changes are reflected
      const qRef = query(collection(db,'projects'), orderBy('order','desc'));
      projectsUnsub = onSnapshot(qRef, (qs)=>{
        cachedProjects = [];
        qs.forEach(d=>{
          const data = d.data();
          cachedProjects.push({ id:d.id, name:data.name||'', html:data.html||'', order:data.order??0 });
        });
        renderProjectsUI();
      });
    }

    /*********************************
     * Ù¡Ù ) Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
     *********************************/
    let codesUnsub = null;
    let codesCache = [];

    function renderCodesTable(){
      codesTable.innerHTML = codesCache.map(c=>{
        const expTs = (typeof c.expiresAt==='number'? c.expiresAt : c.expiresAt?.toMillis?.() ?? 0);
        const stillValid = !c.revoked && !c.suspended && (nowTs() < expTs);
        const usingNow = !!(c.used && !c.suspended && !c.revoked);
        
        let usedPill = usedNowPillHtml(usingNow);
        if(usingNow){
            usedPill = `<div class="flex items-center gap-1">${usedPill} <button class="btn btn-plain text-xs p-1" data-ct-act="force-logout" data-code="${c.id}" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ">âŒ</button></div>`;
        }

        return `
          <tr class="border-b border-slate-200 align-top">
            <td class="py-2 px-1 font-bold text-slate-800">${escapeHtml(c.username||'Ù…Ø³ØªØ®Ø¯Ù…')}</td>
            <td class="py-2 px-1">
              <div class="flex flex-wrap items-center gap-2 mono text-[13px] break-all">
                <span>${c.id}</span>
                <button class="btn btn-plain text-xs p-1" data-ct-act="copy" data-code="${c.id}">Ù†Ø³Ø®</button>
              </div>
            </td>
            <td class="py-2 px-1 text-[13px] text-slate-600">${fmtDate(expTs)}</td>
            <td class="py-2 px-1">${statusPillHtml(stillValid)}</td>
            <td class="py-2 px-1">${usedPill}</td>
            <td class="py-2 px-1">
              <div class="flex flex-wrap gap-1 text-[11px]">
                <button class="btn btn-plain text-xs p-1" data-ct-act="suspend" data-code="${c.id}" data-suspended="${c.suspended?'1':'0'}">${c.suspended?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù':'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª'}</button>
                <button class="btn btn-primary text-xs p-1" data-ct-act="edit" data-code="${c.id}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø©</button>
                <button class="btn btn-danger text-xs p-1" data-ct-act="delete" data-code="${c.id}">Ø­Ø°Ù</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function listenCodes(){
      if(codesUnsub) return;
      const qRef = query(collection(db,'one_time_codes'), orderBy('createdAt','desc'));
      codesUnsub = onSnapshot(qRef,(qs)=>{
        codesCache = [];
        qs.forEach(d=>{ codesCache.push({ id:d.id, ...d.data() }); });
        renderCodesTable();
      });
    }

    genCodeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = gcUsername.value.trim();
      if(!username){ showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠ'); return; }
      const amount = parseInt(gcAmount.value||'1',10);
      const unit = gcUnit.value;
      
      if(editingCodeId){
        const ref = doc(db,'one_time_codes', editingCodeId);
        const code = codesCache.find(c=>c.id===editingCodeId);
        
        const currentExp = (typeof code.expiresAt==='number'? code.expiresAt : code.expiresAt?.toMillis?.() ?? nowTs());
        const newExp = addDuration(currentExp, amount, unit);
        
        await updateDoc(ref,{ username, expiresAt: newExp });
        showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯: '+editingCodeId);
        
        editingCodeId = null;
        genCodeSubmitBtn.textContent = 'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯';
        genCodeSubmitBtn.classList.remove('btn-success');
        genCodeSubmitBtn.classList.add('btn-primary');
        gcUsername.value=''; gcAmount.value=1; gcUnit.value='days';
        
      } else {
        const code = randCode(8);
        const expiresAt = addDuration(nowTs(), amount, unit);
        const ref = doc(db,'one_time_codes', code);
        await setDoc(ref,{
          username, expiresAt, revoked:false, suspended:false, used:false, boundTo:'', lastSeen:0, createdAt: serverTimestamp()
        });
        gcUsername.value='';
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯: '+code);
      }
    });

    codesTable.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-ct-act]');
      if(!btn) return;
      const act = btn.dataset.ctAct;
      const codeId = btn.dataset.code;
      if(!codeId) return;
      const ref = doc(db,'one_time_codes', codeId);

      if(act==='copy'){
        // FIX: Ensure copy functionality works on button click
        try {
            await navigator.clipboard.writeText(codeId);
            showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®');
        } catch (err) {
            showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: Ø­Ø§ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹');
        }
      }else if(act==='suspend'){
        const suspended = btn.dataset.suspended === '1';
        await updateDoc(ref,{ suspended: !suspended });
        showToast(!suspended?'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¤Ù‚ØªØ§Ù‹':'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù');
      }else if(act==='edit'){
          const code = codesCache.find(c=>c.id===codeId);
          if(!code) return;
          
          gcUsername.value = code.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
          gcAmount.value = 1;
          gcUnit.value = 'days';
          
          editingCodeId = codeId;
          genCodeSubmitBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
          genCodeSubmitBtn.classList.remove('btn-primary');
          genCodeSubmitBtn.classList.add('btn-success');
          showTab('codes');
          showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.');
          
      }else if(act==='delete'){
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
          await deleteDoc(ref);
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯');
        }
      }else if(act==='force-logout'){
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')){
           await updateDoc(ref, { used: false, boundTo: '' });
           showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
        }
      }
    });

    /*********************************
     * Ù¡Ù¡) ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±
     *********************************/
    function showTab(which){
      projectsTab.classList.add('hidden');
      codesTab.classList.add('hidden');
      settingsTab.classList.add('hidden');
      aboutDevTab.classList.add('hidden');
      
      // FIX: Update Tab Button Styles to show active tab
      [toProjectsTab, toCodesTab, toSettingsTab, toAboutDevTab].forEach(btn => {
          btn.classList.remove('btn-primary', 'text-white');
          btn.classList.add('btn-plain');
      });

      let activeBtn = null;
      let activeTab = null;
      if(which==='projects') { activeBtn = toProjectsTab; activeTab = projectsTab; }
      if(which==='codes') { activeBtn = toCodesTab; activeTab = codesTab; }
      if(which==='settings') { activeBtn = toSettingsTab; activeTab = settingsTab; }
      if(which==='aboutdev') { activeBtn = toAboutDevTab; activeTab = aboutDevTab; }
      
      if(activeBtn){
          activeBtn.classList.remove('btn-plain');
          activeBtn.classList.add('btn-primary', 'text-white');
      }
      
      if(activeTab) activeTab.classList.remove('hidden');
    }
    showTab('projects');
    toProjectsTab.addEventListener('click',()=>showTab('projects'));
    toCodesTab.addEventListener('click',()=>showTab('codes'));
    toSettingsTab.addEventListener('click',()=>showTab('settings'));
    toAboutDevTab.addEventListener('click',()=>showTab('aboutdev'));

    /*********************************
     * Ù¡Ù¢) ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø­ÙˆÙ„
     *********************************/
    openDrawerBtn.addEventListener('click', ()=>{ 
        drawer.classList.add('open'); 
    });
    closeDrawerBtn.addEventListener('click', ()=>{ 
        drawer.classList.remove('open'); 
    });
    
    aboutDevBtn.addEventListener('click', async (e)=>{ 
        e.preventDefault(); 
        const sRef = doc(db, 'settings', 'main');
        const snap = await getDoc(sRef);
        const html = snap.data()?.aboutDevHtml || '<h2>Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…Ø­ØªÙˆÙ‰ Ù„ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± Ø¨Ø¹Ø¯.</h2>';
        
        // Feature: Project code renders directly into projectHost
        projectHost.innerHTML = html;
        
        drawer.classList.remove('open');
        
        activeProjectId = 'aboutDev';
        renderProjectsUI(); // This now updates the 'Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±' button style
        showToast('ØªÙ… Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±'); 
        
        // Ensure user view is active if clicked from drawer
        if (session.get()?.role === 'user') {
            setView(userView);
        }
    });
    
    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… iframe
function renderProjectInHost(url){
  // 1. ÙØ­Øµ Ø¨Ø³ÙŠØ· Ù„Ù„Ø±Ø§Ø¨Ø·
  if (!url || !url.startsWith('http')) {
      projectHost.innerHTML = `<div class="p-4 text-center text-red-600">
                                <h4 class="font-extrabold mb-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·</h4>
                                <p class="text-sm">Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                               </div>`;
      return;
  }
  
  // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… iframe Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù…Ù†
  projectHost.innerHTML = `
    <iframe 
      src="${url}" 
      style="width: 100%; height: 100%; min-height: 50vh; border: none; background: white;"
      allowfullscreen
      sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
    >
    </iframe>
  `;
}


    /*********************************
     * Ù¡Ù£) ØªÙ‡ÙŠØ¦Ø© - Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§
     *********************************/
    async function restoreSession(){
      const ses = session.get();
      console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', ses);
      
      if(!ses){ 
        console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø©ØŒ Ø¹Ø±Ø¶ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        setView(authView); 
        return; 
      }
      
      if(ses.role==='user'){
        console.log('Ø¬Ù„Ø³Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø³ØªØ¹Ø§Ø¯Ø©...');
        try {
          currentUserName.textContent = ses.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
          codeStatusPill.innerHTML = statusPillHtml(true);
          setView(userView);
          watchProjects();
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙƒÙˆØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§ØªØµØ§Ù„ Ø¥Ù†ØªØ±Ù†Øª
          if(navigator.onLine){
            console.log('Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ØªÙˆÙØ±ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯...');
            await revalidateIfNeeded();
          } else {
            console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹');
            codeStatusPill.innerHTML = statusPillHtml(true);
          }
        } catch(error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
          session.clear();
          setView(authView);
        }
        return;
      }
      
      if(ses.role==='dev'){
        console.log('Ø¬Ù„Ø³Ø© Ù…Ø·ÙˆØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø³ØªØ¹Ø§Ø¯Ø©...');
        try {
          setView(devView);
          watchProjects();
          listenCodes();
          showTab('projects');
        } catch(error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø·ÙˆØ±:', error);
          session.clear();
          setView(authView);
        }
        return;
      }
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©ØŒ Ø§Ù…Ø³Ø­Ù‡Ø§
      console.log('Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©ØŒ Ù…Ø³Ø­...');
      session.clear(); 
      setView(authView);
    }

    function setOnlineAndInitUI(){
      setOnlineUI();
    }

    async function init(){
      console.log('Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
      setOnlineAndInitUI();
      await watchSettings();
      await restoreSession();
      console.log('Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§ÙƒØªÙ…Ù„Øª');
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    init();
  </script>
</body>
</html>
