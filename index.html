<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€“ Ù…Ù„Ù ÙˆØ§Ø­Ø¯</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#0ea5e9;--ink:#0f172a;--muted:#64748b;--surface:#ffffff;--bg:#f1f5f9}
    html,body{height:100%}
    body{background:var(--bg);color:var(--ink)}
    .card{background:var(--surface);border-radius:1.25rem;box-shadow:0 12px 30px rgba(2,6,23,.08);padding:1.25rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:1rem;padding:.8rem 1.1rem;font-weight:800}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-plain{background:#eef2f7}
    .btn-danger{background:#ef4444;color:#fff}
    .chip{display:inline-flex;align-items:center;gap:.35rem;background:#e2e8f0;color:#0f172a;padding:.25rem .6rem;border-radius:999px;font-weight:700}
    .drawer{position:fixed;top:0;bottom:0;right:0;width:305px;background:#0b1220;color:#e5e7eb;transform:translateX(110%);transition:.3s ease;padding:18px 16px 90px 16px;z-index:60;}
    .drawer.open{transform:translateX(0)}
    .drawer a{display:flex;align-items:center;gap:.6rem;padding:.65rem .8rem;border-radius:.8rem;color:#e5e7eb}
    .drawer a:hover{background:rgba(255,255,255,.08)}
    .drawer .footer-fixed{position:absolute;bottom:14px;left:16px;right:16px}
    .bubble{border:1px dashed #cbd5e1;border-radius:1rem;padding:1rem}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .fade-enter{animation:fade .25s ease}
    @keyframes fade{from{opacity:.0;transform:translateY(4px)}to{opacity:1;transform:none}}
    .toast{position:fixed;bottom:18px;right:18px;z-index:80}
  </style>
</head>
<body class="min-h-screen">
  <!-- Top App Bar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-6xl px-3 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="openDrawerBtn" class="btn btn-plain" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
          <!-- Hamburger -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1 class="font-black tracking-tight">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1>
      </div>
      <div id="onlinePill" class="chip"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Ù…ØªØµÙ„</div>
    </div>
  </header>

  <!-- Drawer (Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø£Ø«Ù†Ø§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„) -->
  <aside id="drawer" class="drawer">
    <div class="flex items-center justify-between mb-2">
      <div class="font-extrabold text-lg">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
      <button id="closeDrawerBtn" class="btn btn-plain" title="Ø¥ØºÙ„Ø§Ù‚">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <nav id="projectsList" class="space-y-1 overflow-y-auto" style="max-height: 70vh;"></nav>

    <div class="footer-fixed">
      <a id="aboutDevBtn" href="#" class="hover:no-underline"><span class="chip">Ø­ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</span></a>
      <div class="mt-3 grid grid-cols-4 gap-2 items-center">
        <button id="logoutBtn" class="btn btn-danger col-span-1">Ø®Ø±ÙˆØ¬</button>
        <!-- Ø«Ù„Ø§Ø« Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø«Ø§Ø¨ØªØ© -->
        <a id="socWa" class="btn btn-plain justify-center" target="_blank" rel="noopener" title="ÙˆØ§ØªØ³Ø§Ø¨" href="#">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M.057 24l1.687-6.163A10.9 10.9 0 0 1 0 10.989C0 4.93 4.93 0 10.988 0a10.95 10.95 0 0 1 7.78 3.223 10.95 10.95 0 0 1 3.222 7.78c0 6.059-4.93 10.988-10.988 10.988a10.9 10.9 0 0 1-5.21-1.354L.057 24zM6.6 19.36c1.676.995 3.276 1.591 4.388 1.591h.004c4.987 0 9.06-4.073 9.06-9.06.002-2.423-.942-4.701-2.652-6.412A9.02 9.02 0 0 0 10.99 1.5C6.003 1.5 1.93 5.573 1.93 10.56c0 1.75.46 3.457 1.334 4.956l-.88 3.226 3.216-.86z"/></svg>
        </a>
        <a id="socTg" class="btn btn-plain justify-center" target="_blank" rel="noopener" title="ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…" href="#">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M9.036 15.186l-.398 5.607c.57 0 .816-.245 1.111-.54l2.665-2.56 5.527 4.04c1.013.56 1.733.266 2.013-.94l3.647-17.083h.001c.324-1.51-.546-2.1-1.537-1.73L1.12 9.31c-1.477.574-1.455 1.398-.25 1.77l5.76 1.797 13.4-8.45c.63-.39 1.207-.175.734.25"/></svg>
        </a>
        <a id="socIg" class="btn btn-plain justify-center" target="_blank" rel="noopener" title="Ø¥Ù†Ø³ØªØºØ±Ø§Ù…" href="#">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm0 2h10c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H7c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3zm11 1a1 1 0 100 2 1 1 0 000-2zM12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
        </a>
      </div>
    </div>
  </aside>

  <!-- Main Container -->
  <main class="mx-auto max-w-6xl px-3 py-6 space-y-6">
    <!-- Maintenance Banner -->
    <section id="maintenanceBanner" class="hidden card fade-enter border border-amber-200 bg-amber-50">
      <div class="flex items-start gap-3">
        <div class="pt-1"><span class="inline-block w-3 h-3 rounded-full bg-amber-500"></span></div>
        <div>
          <h2 class="font-extrabold text-amber-800 mb-1">Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
          <p class="text-amber-800/90 mb-3">Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ù‚ÙˆÙ… Ø¨Ø£Ø¹Ù…Ø§Ù„ ØµÙŠØ§Ù†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹. Ù„Ù„ØªÙˆØ§ØµÙ„:</p>
          <div class="flex gap-2 flex-wrap">
            <a id="mWa" class="btn btn-primary" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
            <a id="mTg" class="btn btn-plain" target="_blank" rel="noopener">ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</a>
            <a id="mIg" class="btn btn-plain" target="_blank" rel="noopener">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Auth (ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø©) -->
    <section id="authView" class="card fade-enter">
      <h2 class="font-black text-xl mb-3">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="bubble">
        <h3 class="font-extrabold mb-2">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</h3>
        <p class="text-sm text-slate-600 mb-3">Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙˆØ¯ Ù…Ø·ÙˆÙ‘Ø± Ø³ØªØ¯Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±ØŒ ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙŠØªÙ… ÙØªØ­ Ø£ÙˆÙ„ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
        <form id="userLoginForm" class="space-y-2">
          <input required id="userCodeInput" class="w-full rounded-xl border px-3 py-2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯" />
          <button class="btn btn-primary w-full" type="submit">Ø¯Ø®ÙˆÙ„</button>
          <div class="text-xs text-slate-500">Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„ Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª.</div>
        </form>
      </div>
    </section>

    <!-- User Dashboard -->
    <section id="userView" class="hidden fade-enter">
      <div class="card mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="chip">Ù…Ø³ØªØ®Ø¯Ù…:</span>
            <span id="currentUserName" class="font-extrabold"></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-slate-600">
            <span>Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯:</span>
            <span id="codeStatusPill" class="chip">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          </div>
        </div>
      </div>
      
        <div class="card md:col-span-2">
          <h3 class="font-extrabold mb-2">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶</h3>
          <div id="projectHost" class="rounded-xl border h-[60vh] overflow-auto p-3 bg-white"></div>
        </div>
      </div>
    </section>

    <!-- Developer Panel -->
    <section id="devView" class="hidden fade-enter">
      <div class="card mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="chip">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</span>
            <button id="toProjectsTab" class="btn btn-plain">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
            <button id="toCodesTab" class="btn btn-plain">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
            <button id="toSettingsTab" class="btn btn-plain">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
          <button id="devLogoutBtn" class="btn btn-danger">Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</button>
        </div>
      </div>

      <div id="devTabs" class="space-y-6">
        <!-- Projects Tab -->
        <div id="projectsTab" class="card">
          <h3 class="font-extrabold mb-3">Ø¥Ø¶Ø§ÙØ© / ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3>
          <form id="addProjectForm" class="space-y-3">
            <input id="projName" class="w-full rounded-xl border px-3 py-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù…Ø«Ø§Ù„: Ù…Ø§Ø¯Ø© 140)" required />
            <textarea id="projHTML" class="w-full rounded-xl border px-3 py-2 mono" rows="10" placeholder="Ø£Ù„ØµÙ‚ ÙƒÙˆØ¯ HTML Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§" required></textarea>
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-primary" type="submit">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</button>
              <button id="clearProjectForm" class="btn btn-plain" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
            </div>
            <div class="text-xs text-slate-500">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Firestore ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª.</div>
          </form>

          <hr class="my-4"/>
          <h4 class="font-extrabold mb-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
          <div id="projectsManager" class="space-y-2"></div>
        </div>

        <!-- Codes Tab -->
        <div id="codesTab" class="card hidden">
          <h3 class="font-extrabold mb-3">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡Ø§</h3>
          <form id="genCodeForm" class="grid md:grid-cols-4 gap-2 items-end">
            <div class="md:col-span-1">
              <label class="text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
              <input id="gcUsername" required class="w-full rounded-xl border px-3 py-2" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ù…Ø­Ø³Ù†" />
            </div>
            <div>
              <label class="text-sm">Ø§Ù„Ù…Ø¯Ù‘Ø©</label>
              <input id="gcAmount" type="number" min="1" value="1" class="w-full rounded-xl border px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
              <select id="gcUnit" class="w-full rounded-xl border px-3 py-2">
                <option value="minutes">Ø¯Ù‚Ø§Ø¦Ù‚</option>
                <option value="hours">Ø³Ø§Ø¹Ø§Øª</option>
                <option value="days" selected>Ø£ÙŠØ§Ù…</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
              </select>
            </div>
            <div>
              <button class="btn btn-primary w-full" type="submit">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
            </div>
          </form>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th>Ø§Ù„ÙƒÙˆØ¯</th>
                  <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¢Ù†</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="codesTable"></tbody>
            </table>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="card hidden">
          <h3 class="font-extrabold mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</h3>
          <form id="settingsForm" class="grid md:grid-cols-3 gap-3">
            <div class="md:col-span-1">
              <label class="text-sm font-bold">ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
              <div class="mt-2 flex items-center gap-2">
                <input id="maintenanceToggle" type="checkbox" class="scale-125"/>
                <span class="text-sm text-slate-600">Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„: ÙŠÙ…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ ÙˆÙŠØ¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙŠØ§Ù†Ø©.</span>
              </div>
            </div>
            <div>
              <label class="text-sm font-bold">Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</label>
              <input id="setWa" class="w-full rounded-xl border px-3 py-2" placeholder="https://wa.me/"/>
            </div>
            <div>
              <label class="text-sm font-bold">Ø±Ø§Ø¨Ø· ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</label>
              <input id="setTg" class="w-full rounded-xl border px-3 py-2" placeholder="https://t.me/"/>
            </div>
            <div>
              <label class="text-sm font-bold">Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</label>
              <input id="setIg" class="w-full rounded-xl border px-3 py-2" placeholder="https://instagram.com/"/>
            </div>
            <div class="md:col-span-3">
              <label class="text-sm font-bold">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</label>
              <input id="setDevKey" class="w-full rounded-xl border px-3 py-2" placeholder="Ø¶Ø¹ ÙƒÙˆØ¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±"/>
            </div>
            <div class="md:col-span-3">
              <button class="btn btn-primary" type="submit">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase + App Script -->
  <script type="module">
    /*********************************
     * Ù¡) Firebase
     *********************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection,
      addDoc, deleteDoc, query, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // âœ… CONFIG Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡
    const firebaseConfig = {
      apiKey: "AIzaSyBXN4njw1kCHPV28kEYmAk_8a0iazlkbfY",
      authDomain: "memu99m.firebaseapp.com",
      projectId: "memu99m",
      storageBucket: "memu99m.firebasestorage.app",
      messagingSenderId: "460246646958",
      appId: "1:460246646958:web:6133e858bce2444a3c6d3f",
      measurementId: "G-65FLDMSM1P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    /*********************************
     * Ù¢) DOM helpers
     *********************************/
    const $ = (s)=>document.querySelector(s);
    const drawer = $('#drawer');
    const openDrawerBtn = $('#openDrawerBtn');
    const closeDrawerBtn = $('#closeDrawerBtn');
    const projectsList = $('#projectsList');
    const projectHost = $('#projectHost');
    const logoutBtn = $('#logoutBtn');
    const aboutDevBtn = $('#aboutDevBtn');
    const onlinePill = $('#onlinePill');
    const toastEl = $('#toast');

    const maintenanceBanner = $('#maintenanceBanner');
    const authView = $('#authView');
    const userView = $('#userView');
    const devView = $('#devView');

    const userLoginForm = $('#userLoginForm');
    const userCodeInput = $('#userCodeInput');

    const currentUserName = $('#currentUserName');
    const codeStatusPill = $('#codeStatusPill');

    const toProjectsTab = $('#toProjectsTab');
    const toCodesTab = $('#toCodesTab');
    const toSettingsTab = $('#toSettingsTab');

    const projectsTab = $('#projectsTab');
    const codesTab = $('#codesTab');
    const settingsTab = $('#settingsTab');

    const addProjectForm = $('#addProjectForm');
    const projName = $('#projName');
    const projHTML = $('#projHTML');
    const clearProjectForm = $('#clearProjectForm');
    const projectsManager = $('#projectsManager');

    const genCodeForm = $('#genCodeForm');
    const gcUsername = $('#gcUsername');
    const gcAmount = $('#gcAmount');
    const gcUnit = $('#gcUnit');
    const codesTable = $('#codesTable');

    const settingsForm = $('#settingsForm');
    const maintenanceToggle = $('#maintenanceToggle');
    const setWa = $('#setWa');
    const setTg = $('#setTg');
    const setIg = $('#setIg');
    const setDevKey = $('#setDevKey');

    const socWa = $('#socWa');
    const socTg = $('#socTg');
    const socIg = $('#socIg');
    const mWa = $('#mWa');
    const mTg = $('#mTg');
    const mIg = $('#mIg');

    /*********************************
     * Ù£) Helpers
     *********************************/
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const deviceId = (function(){
      let id = localStorage.getItem('deviceId');
      if(!id){ id = crypto.randomUUID(); localStorage.setItem('deviceId', id); }
      return id;
    })();

    function showToast(msg){
      toastEl.classList.remove('hidden');
      toastEl.innerHTML = `<div class="card">${msg}</div>`;
      setTimeout(()=>toastEl.classList.add('hidden'), 2400);
    }

    function setOnlineUI(){
      const online = navigator.onLine;
      onlinePill.innerHTML = online
        ? '<span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Ù…ØªØµÙ„'
        : '<span class="inline-block w-2 h-2 rounded-full bg-slate-400"></span> ØºÙŠØ± Ù…ØªØµÙ„';
    }
    window.addEventListener('online',()=>{ setOnlineUI(); revalidateIfNeeded(); });
    window.addEventListener('offline',()=>{ setOnlineUI(); });

    function nowTs(){ return Date.now(); }
    function addDuration(ms, amount, unit){
      const map = {minutes:60000, hours:3600000, days:86400000, months:2629800000};
      return ms + (map[unit]||86400000) * amount;
    }
    function fmtDate(ts){
      try{ return new Date(ts).toLocaleString('ar-IQ'); }catch{return ts}
    }
    function randCode(len=8){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out=''; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function statusPillHtml(valid){
      return valid ? '<span class="chip"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> ØµØ§Ù„Ø­</span>'
                   : '<span class="chip"><span class="inline-block w-2 h-2 rounded-full bg-rose-500"></span> ØºÙŠØ± ØµØ§Ù„Ø­</span>';
    }
    function usedNowPillHtml(used){
      return used ? '<span class="chip"><span class="inline-block w-2 h-2 rounded-full bg-amber-500"></span> ÙŠÙØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù†</span>'
                  : '<span class="chip">ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…</span>';
    }
    function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    /*********************************
     * Ù¤) Ø¬Ù„Ø³Ø©
     *********************************/
    const session = {
      get(){ try{return JSON.parse(localStorage.getItem('session')||'null')}catch{return null} },
      set(obj){ localStorage.setItem('session', JSON.stringify(obj)); },
      clear(){ localStorage.removeItem('session'); }
    };
    function setView(view){
      for(const el of [authView,userView,devView]) el.classList.add('hidden');
      view.classList.remove('hidden');
    }

    /*********************************
     * Ù¥) Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
     *********************************/
    let settingsDocUnsub = null;
    async function watchSettings(){
      if(settingsDocUnsub) settingsDocUnsub();
      const sRef = doc(db, 'settings', 'main');
      settingsDocUnsub = onSnapshot(sRef, (snap)=>{
        const s = snap.exists()? snap.data(): {};
        const { maintenance=false, wa='#', tg='#', ig='#', devKey='' } = s;
        maintenanceToggle.checked = !!maintenance;
        setWa.value = wa || '';
        setTg.value = tg || '';
        setIg.value = ig || '';
        setDevKey.value = devKey || '';

        [socWa,mWa].forEach(a=>a.href = wa||'#');
        [socTg,mTg].forEach(a=>a.href = tg||'#');
        [socIg,mIg].forEach(a=>a.href = ig||'#');

        const ses = session.get();
        maintenanceBanner.classList.toggle('hidden', !maintenance);
        if(maintenance){
          if(ses && ses.role==='user' && navigator.onLine){
            showToast('Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ØµÙŠØ§Ù†Ø© â€” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ');
            doLogout();
          }
        }
      });
    }
    settingsForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const sRef = doc(db, 'settings', 'main');
      await setDoc(sRef, {
        maintenance: maintenanceToggle.checked,
        wa: setWa.value.trim(),
        tg: setTg.value.trim(),
        ig: setIg.value.trim(),
        devKey: setDevKey.value.trim()
      }, { merge:true });
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    });

    /*********************************
     * Ù¦) ØªØ­Ù‚Ù‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ + Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯
     *********************************/
    async function verifyCodeOnline(code){
      const ref = doc(db,'one_time_codes', code);
      const snap = await getDoc(ref);
      if(!snap.exists()) return { ok:false, reason:'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
      const data = snap.data();
      const { username='Ù…Ø³ØªØ®Ø¯Ù…', expiresAt=0, revoked=false, suspended=false, used=false, boundTo='' } = data;
      const exp = (typeof expiresAt==='number'? expiresAt : expiresAt?.toMillis?.() ?? 0);
      const validTime = nowTs() < exp;
      if(revoked) return { ok:false, reason:'Ø§Ù„ÙƒÙˆØ¯ Ù…Ù„ØºÙŠ', data };
      if(suspended) return { ok:false, reason:'Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªØ§Ù‹', data };
      if(!validTime) return { ok:false, reason:'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯', data };

      if(boundTo && boundTo !== deviceId){
        return { ok:false, reason:'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±', data };
      }

      await setDoc(ref, { used:true, boundTo: deviceId, lastSeen: nowTs() }, {merge:true});
      return { ok:true, data:{...data, username, expiresAt:exp, used:true, boundTo:deviceId} };
    }
    async function revalidateIfNeeded(){
      const ses = session.get();
      if(!ses || ses.role!=='user') return;
      if(!navigator.onLine) return;
      const res = await verifyCodeOnline(ses.code);
      if(!res.ok){
        codeStatusPill.innerHTML = statusPillHtml(false);
        showToast(res.reason||'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©');
        await sleep(600);
        doLogout();
      }else{
        codeStatusPill.innerHTML = statusPillHtml(true);
      }
    }

    /*********************************
     * Ù§) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø©)
     *********************************/
    userLoginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const inputCode = userCodeInput.value.trim();
      if(!inputCode) return;

      // Ù…Ø·ÙˆÙ‘Ø±ØŸ
      if(inputCode && inputCode.trim() === (setDevKey.value.trim() || '')){
        session.set({ role:'dev' });
        setView(devView);
        watchProjects();
        listenCodes();
        watchSettings();
        showToast('Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ğŸ‘¨â€ğŸ’»');
        return;
      }

      // Ù…Ø³ØªØ®Ø¯Ù…ØŸ
      if(maintenanceToggle.checked){
        showToast('Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹');
        return;
      }
      if(!navigator.onLine){
        showToast('ÙŠØªØ·Ù„Ø¨ Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©');
        return;
      }
      const code = inputCode.toUpperCase();
      const res = await verifyCodeOnline(code);
      if(!res.ok){
        showToast(res.reason || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯');
        return;
      }
      const username = res.data.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
      currentUserName.textContent = username;
      codeStatusPill.innerHTML = statusPillHtml(true);
      session.set({ role:'user', code, username, expiresAt:res.data.expiresAt || 0 });
      setView(userView);
      watchProjects();
      await revalidateIfNeeded();
      showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ '+username+' âœ¨');
    });

    /*********************************
     * Ù¨) Ø§Ù„Ø®Ø±ÙˆØ¬
     *********************************/
    function doLogout(){
      session.clear();
      setView(authView);
    }
    logoutBtn.addEventListener('click', ()=>{ doLogout(); showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); });
    $('#devLogoutBtn')?.addEventListener('click', ()=>{ doLogout(); showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±'); });

    /*********************************
     * Ù©) Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Ø¥Ø¶Ø§ÙØ©/ØªØ±ØªÙŠØ¨/Ø¹Ø±Ø¶)
     *********************************/
    let projectsUnsub = null;
    let cachedProjects = [];

    function renderProjectsUI(){
      projectsList.innerHTML = cachedProjects.map((p)=>`
        <a href="#" data-projid="${p.id}" class="bg-white/5 hover:bg-white/10 text-sm font-bold">
          <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
          <span>${escapeHtml(p.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</span>
        </a>
      `).join('');

      projectsManager.innerHTML = cachedProjects.map((p,i)=>`
        <div class="border border-slate-200 rounded-xl p-3 bg-white text-slate-800">
          <div class="flex flex-wrap items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="font-extrabold text-slate-900 text-sm">${escapeHtml(p.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</div>
              <div class="text-[11px] text-slate-500 break-all mono">ID: ${p.id}</div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button class="btn btn-plain text-xs" data-act="up" data-pid="${p.id}">ÙÙˆÙ‚â†‘</button>
              <button class="btn btn-plain text-xs" data-act="down" data-pid="${p.id}">ØªØ­Øªâ†“</button>
              <button class="btn btn-danger text-xs" data-act="del" data-pid="${p.id}">Ø­Ø°Ù</button>
              <button class="btn btn-plain text-xs" data-act="preview" data-pid="${p.id}">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            </div>
          </div>
        </div>
      `).join('');

      openFirstProjectIfAny();
    }

    function swapOrder(i,j){
      if(i<0 || j<0 || i>=cachedProjects.length || j>=cachedProjects.length) return;
      const pi = cachedProjects[i], pj = cachedProjects[j];
      const piRef = doc(db,'projects',pi.id);
      const pjRef = doc(db,'projects',pj.id);
      const oldI = pi.order ?? i, oldJ = pj.order ?? j;
      cachedProjects[i].order = oldJ;
      cachedProjects[j].order = oldI;
      updateDoc(piRef,{order:oldJ}).catch(()=>{});
      updateDoc(pjRef,{order:oldI}).catch(()=>{});
    }

    projectsManager.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const pid = btn.dataset.pid;
      const idx = cachedProjects.findIndex(p=>p.id===pid);
      if(idx===-1) return;

      if(act==='up'){ swapOrder(idx, idx-1); renderProjectsUI(); }
      else if(act==='down'){ swapOrder(idx, idx+1); renderProjectsUI(); }
      else if(act==='del'){
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
          await deleteDoc(doc(db,'projects',pid));
          showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        }
      }else if(act==='preview'){
        const p = cachedProjects[idx];
        projectHost.innerHTML = p.html || '';
        setView(userView);
        drawer.classList.remove('open');
        showToast('ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
      }
    });

    projectsList.addEventListener('click',(e)=>{
      const link = e.target.closest('[data-projid]');
      if(!link) return;
      const pid = link.dataset.projid;
      const p = cachedProjects.find(x=>x.id===pid);
      if(!p) return;
      projectHost.innerHTML = p.html || '';
      drawer.classList.remove('open');
    });

    // Ø£ÙˆÙ„ Ù…Ø´Ø±ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function openFirstProjectIfAny(){
      const ses = session.get();
      if(!ses || ses.role!=='user') return;
      if(userView && !userView.classList.contains('hidden')){
        if(projectHost && (!projectHost.innerHTML || projectHost.innerHTML.trim()==='')){
          const first = cachedProjects[0];
          if(first){ projectHost.innerHTML = first.html || ''; }
        }
      }
    }

    addProjectForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = projName.value.trim();
      const html = projHTML.value;
      if(!name || !html){ showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
      await addDoc(collection(db,'projects'), { name, html, order: nowTs() });
      projName.value=''; projHTML.value='';
      showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
    });
    clearProjectForm.addEventListener('click', ()=>{ projName.value=''; projHTML.value=''; });

    function watchProjects(){
      if(projectsUnsub) return;
      const qRef = query(collection(db,'projects'), orderBy('order','asc'));
      projectsUnsub = onSnapshot(qRef, (qs)=>{
        cachedProjects = [];
        qs.forEach(d=>{
          const data = d.data();
          cachedProjects.push({ id:d.id, name:data.name||'', html:data.html||'', order:data.order??0 });
        });
        renderProjectsUI();
      });
    }

    /*********************************
     * Ù¡Ù ) Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
     *********************************/
    let codesUnsub = null;
    let codesCache = [];

    function renderCodesTable(){
      codesTable.innerHTML = codesCache.map(c=>{
        const expTs = (typeof c.expiresAt==='number'? c.expiresAt : c.expiresAt?.toMillis?.() ?? 0);
        const stillValid = !c.revoked && !c.suspended && (nowTs() < expTs);
        const usingNow = !!(c.used && !c.suspended && !c.revoked);
        return `
          <tr class="border-b align-top">
            <td class="py-2 font-bold text-slate-800">${escapeHtml(c.username||'Ù…Ø³ØªØ®Ø¯Ù…')}</td>
            <td class="py-2">
              <div class="flex flex-wrap items-center gap-2 mono text-[13px] break-all">
                <span>${c.id}</span>
                <button class="btn btn-plain text-xs" data-ct-act="copy" data-code="${c.id}">Ù†Ø³Ø®</button>
              </div>
            </td>
            <td class="py-2 text-[13px] text-slate-600">${fmtDate(expTs)}</td>
            <td class="py-2">${statusPillHtml(stillValid)}</td>
            <td class="py-2">${usedNowPillHtml(usingNow)}</td>
            <td class="py-2">
              <div class="flex flex-wrap gap-1 text-[11px]">
                <button class="btn btn-plain text-xs" data-ct-act="suspend" data-code="${c.id}" data-suspended="${c.suspended?'1':'0'}">${c.suspended?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù':'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª'}</button>
                <button class="btn btn-plain text-xs" data-ct-act="edit" data-code="${c.id}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø©</button>
                <button class="btn btn-danger text-xs" data-ct-act="delete" data-code="${c.id}">Ø­Ø°Ù</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function listenCodes(){
      if(codesUnsub) return;
      const qRef = query(collection(db,'one_time_codes'), orderBy('createdAt','desc'));
      codesUnsub = onSnapshot(qRef,(qs)=>{
        codesCache = [];
        qs.forEach(d=>{ codesCache.push({ id:d.id, ...d.data() }); });
        renderCodesTable();
      });
    }

    genCodeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = gcUsername.value.trim();
      if(!username){ showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠ'); return; }
      const amount = parseInt(gcAmount.value||'1',10);
      const unit = gcUnit.value;
      const code = randCode(8);
      const expiresAt = addDuration(nowTs(), amount, unit);
      const ref = doc(db,'one_time_codes', code);
      await setDoc(ref,{
        username, expiresAt, revoked:false, suspended:false, used:false, boundTo:'', lastSeen:0, createdAt: serverTimestamp()
      });
      gcUsername.value='';
      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯: '+code);
    });

    codesTable.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-ct-act]');
      if(!btn) return;
      const act = btn.dataset.ctAct;
      const codeId = btn.dataset.code;
      if(!codeId) return;
      const ref = doc(db,'one_time_codes', codeId);

      if(act==='copy'){
        await navigator.clipboard.writeText(codeId);
        showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®');
      }else if(act==='suspend'){
        const suspended = btn.dataset.suspended === '1';
        await updateDoc(ref,{ suspended: !suspended });
        showToast(!suspended?'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¤Ù‚ØªØ§Ù‹':'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù');
      }else if(act==='edit'){
        const extraDaysStr = prompt('Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ù…Ø«Ø§Ù„: 1)');
        if(!extraDaysStr) return;
        const extraDays = parseInt(extraDaysStr,10);
        if(isNaN(extraDays) || extraDays<=0){ showToast('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); return; }
        const snap = await getDoc(ref);
        if(!snap.exists()){ showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯'); return; }
        const data = snap.data();
        const currentExp = (typeof data.expiresAt==='number'? data.expiresAt : data.expiresAt?.toMillis?.() ?? nowTs());
        const newExp = addDuration(currentExp, extraDays, 'days');
        await updateDoc(ref,{ expiresAt: newExp });
        showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
      }else if(act==='delete'){
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
          await deleteDoc(ref);
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯');
        }
      }
    });

    /*********************************
     * Ù¡Ù¡) ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±
     *********************************/
    function showTab(which){
      projectsTab.classList.add('hidden');
      codesTab.classList.add('hidden');
      settingsTab.classList.add('hidden');
      if(which==='projects') projectsTab.classList.remove('hidden');
      if(which==='codes') codesTab.classList.remove('hidden');
      if(which==='settings') settingsTab.classList.remove('hidden');
    }
    showTab('projects');
    toProjectsTab.addEventListener('click',()=>showTab('projects'));
    toCodesTab.addEventListener('click',()=>showTab('codes'));
    toSettingsTab.addEventListener('click',()=>showTab('settings'));

    /*********************************
     * Ù¡Ù¢) ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø­ÙˆÙ„
     *********************************/
    openDrawerBtn.addEventListener('click', ()=>{ drawer.classList.add('open'); });
    closeDrawerBtn.addEventListener('click', ()=>{ drawer.classList.remove('open'); });
    aboutDevBtn.addEventListener('click',(e)=>{ e.preventDefault(); showToast('Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† ØªØ·ÙˆÙŠØ±Ùƒ âœ¨'); });

    /*********************************
     * Ù¡Ù£) ØªÙ‡ÙŠØ¦Ø©
     *********************************/
    async function restoreSession(){
      const ses = session.get();
      if(!ses){ setView(authView); return; }
      if(ses.role==='user'){
        currentUserName.textContent = ses.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
        codeStatusPill.innerHTML = statusPillHtml(true);
        setView(userView);
        watchProjects();
        await revalidateIfNeeded();
        return;
      }
      if(ses.role==='dev'){
        setView(devView);
        watchProjects();
        listenCodes();
        watchSettings();
        return;
      }
      session.clear(); setView(authView);
    }

    function setOnlineAndInitUI(){
      setOnlineUI();
    }

    async function init(){
      setOnlineAndInitUI();
      await watchSettings();
      await restoreSession();
      const ses = session.get();
      if(ses && ses.role==='dev'){ listenCodes(); }
    }
    init();
  </script>
</body>
</html>